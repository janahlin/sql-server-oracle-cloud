---
- name: Deploy Oracle Cloud Infrastructure
  hosts: localhost
  connection: local
  gather_facts: true

  tasks:
    - name: Initialize Terraform
      ansible.builtin.command: terraform init
      args:
        chdir: "{{ playbook_dir }}/../../terraform/environments/dev"
      changed_when: false

    - name: Run Terraform plan with command line variables
      ansible.builtin.command: terraform plan
      args:
        chdir: "{{ playbook_dir }}/../../terraform/environments/dev"
      register: terraform_plan
      changed_when: false

    - name: Apply Terraform changes with command line variables
      ansible.builtin.command: terraform apply -auto-approve
      args:
        chdir: "{{ playbook_dir }}/../../terraform/environments/dev"
      register: terraform_apply
      changed_when: false
      failed_when: false

    - name: Get Terraform outputs
      ansible.builtin.command: terraform output -json
      args:
        chdir: "{{ playbook_dir }}/../../terraform/environments/dev"
      register: terraform_output
      changed_when: false
      failed_when: false

    - name: Parse Terraform outputs
      ansible.builtin.set_fact:
        terraform_outputs: "{{ terraform_output.stdout | from_json if terraform_output.rc == 0 else {} }}"
      failed_when: false

    - name: Set Windows VM IP
      ansible.builtin.set_fact:
        windows_vm_ip: "{{ terraform_outputs.windows_vm_public_ip.value if terraform_outputs.windows_vm_public_ip is defined else 'unknown' }}"
      failed_when: false

    - name: Update Ansible inventory with Windows VM IP
      ansible.builtin.template:
        src: "{{ lookup('env', 'PWD') }}/templates/hosts.j2"
        dest: "{{ lookup('env', 'PWD') }}/inventory/hosts"
        mode: '0644'
      failed_when: false
